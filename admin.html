<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel ‚Äî CricAnalytics Pro</title>
    <link rel="stylesheet" href="style.css" />
    <style>
        .admin-login-wrap {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .admin-login-card {
            background: rgba(15, 22, 40, 0.98);
            border: 1px solid rgba(165, 94, 234, 0.35);
            border-radius: var(--radius-xl);
            padding: 40px;
            width: 100%;
            max-width: 380px;
            text-align: center;
        }

        .admin-login-card h2 {
            font-size: 1.3rem;
            margin-bottom: 6px;
        }

        .admin-login-card p {
            font-size: 0.82rem;
            color: var(--text-muted);
            margin-bottom: 28px;
        }

        #admin-panel {
            display: none;
        }

        .edit-field-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .edit-field-row .form-control {
            flex: 1;
        }

        .match-edit-row td {
            vertical-align: middle;
        }

        .match-edit-row input {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-primary);
            padding: 6px 10px;
            font-size: 0.82rem;
            width: 70px;
        }
    </style>
</head>

<body>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- ADMIN LOGIN WALL -->
    <div class="admin-login-wrap" id="admin-login-wrap">
        <div class="admin-login-card">
            <div style="font-size:2.5rem;margin-bottom:12px">üîí</div>
            <h2 style="color:var(--accent-purple)">Admin Panel</h2>
            <p>Enter admin password to continue</p>
            <div class="form-group">
                <input type="password" id="admin-pw-input" class="form-control" placeholder="Admin password"
                    style="text-align:center" />
            </div>
            <button class="btn" style="width:100%;justify-content:center;background:var(--gradient-purple);color:#fff"
                onclick="doAdminLogin()">
                üîì Unlock Panel
            </button>
            <p style="margin-top:16px;font-size:0.75rem;color:var(--text-muted)">Default: admin@cricket123</p>
            <a href="index.html"
                style="display:block;margin-top:12px;font-size:0.8rem;color:var(--text-muted);text-decoration:none">‚Üê
                Back to Login</a>
        </div>
    </div>

    <!-- ADMIN PANEL (shown after login) -->
    <div id="admin-panel">
        <div class="app-wrapper">
            <nav class="sidebar" id="sidebar">
                <button class="sidebar-close" id="sidebar-close">‚úï</button>
                <div class="sidebar-logo"><span class="cricket-emoji">üîí</span>
                    <div class="logo-text">Admin Panel</div>
                    <div class="logo-sub">CricAnalytics Pro</div>
                </div>
                <div class="sidebar-nav">
                    <div class="nav-section-title">Admin</div>
                    <a class="nav-item" href="#" onclick="showSection('players')"><span class="nav-icon">üë•</span>
                        Manage Players</a>
                    <a class="nav-item" href="#" onclick="showSection('matches')"><span class="nav-icon">üìã</span>
                        Manage Matches</a>
                    <a class="nav-item" href="#" onclick="showSection('settings')"><span class="nav-icon">‚öôÔ∏è</span>
                        Settings</a>
                    <div class="nav-section-title">App</div>
                    <a class="nav-item" href="dashboard.html"><span class="nav-icon">üè†</span> Dashboard</a>
                    <a class="nav-item" href="players.html"><span class="nav-icon">üë•</span> All Players</a>
                </div>
                <div class="sidebar-footer">
                    <button class="admin-btn" onclick="adminLogout()">üö™ Logout Admin</button>
                </div>
            </nav>

            <div class="main-content">
                <div class="topbar">
                    <div style="display:flex;align-items:center;gap:12px">
                        <button class="hamburger" id="hamburger">‚ò∞</button>
                        <h1>üîí Admin Panel</h1>
                    </div>
                    <div class="topbar-right">
                        <span style="font-size:0.8rem;color:var(--accent-purple);font-weight:700">Admin Mode</span>
                    </div>
                </div>

                <div class="page-content">

                    <!-- PLAYERS SECTION -->
                    <div id="section-players">
                        <div class="glass-card">
                            <div class="card-header">
                                <h2>üë• Manage Players</h2>
                                <div style="display:flex;align-items:center;gap:10px;margin-left:auto">
                                    <span id="refresh-stamp" style="font-size:0.72rem;color:var(--accent-green)"></span>
                                    <span style="font-size:0.8rem;color:var(--text-muted)"
                                        id="admin-player-count"></span>
                                    <button onclick="adminRefreshNow()"
                                        style="background:none;border:1px solid var(--glass-border);border-radius:8px;padding:4px 12px;color:var(--accent-gold);cursor:pointer;font-size:0.82rem">üîÑ
                                        Refresh</button>
                                </div>
                            </div>
                            <div class="card-body" style="padding:0">
                                <div class="table-container">
                                    <table id="admin-players-table">
                                        <thead>
                                            <tr>
                                                <th>Player</th>
                                                <th>üì± Registration No.</th>
                                                <th>Role</th>
                                                <th>Type</th>
                                                <th>Matches</th>
                                                <th>Runs</th>
                                                <th>Avg</th>
                                                <th>SR</th>
                                                <th>Wickets</th>
                                                <th>Eco</th>
                                                <th>MOTM</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-players-tbody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- MATCHES SECTION -->
                    <div id="section-matches" style="display:none">
                        <div class="filter-bar mb-4">
                            <select id="admin-player-select" class="form-control" onchange="loadAdminMatches()">
                                <option value="">‚Äî Select Player ‚Äî</option>
                            </select>
                        </div>
                        <div class="glass-card">
                            <div class="card-header">
                                <h2>üìã Manage Matches</h2>
                            </div>
                            <div class="card-body" style="padding:0">
                                <div class="table-container">
                                    <table id="admin-matches-table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Tournament</th>
                                                <th>Runs</th>
                                                <th>Balls</th>
                                                <th>Wickets</th>
                                                <th>Runs(B)</th>
                                                <th>MOTM</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="admin-matches-tbody"></tbody>
                                    </table>
                                    <div id="admin-matches-empty" class="empty-state" style="display:none">
                                        <div class="empty-icon">üìã</div>
                                        <h3>Select a player to view matches</h3>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SETTINGS SECTION -->
                    <div id="section-settings" style="display:none">
                        <div class="glass-card" style="max-width:480px">
                            <div class="card-header">
                                <h2>‚öôÔ∏è Admin Settings</h2>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label>Change Admin Password</label>
                                    <input type="password" id="new-pw" class="form-control"
                                        placeholder="New password" />
                                </div>
                                <div class="form-group">
                                    <input type="password" id="confirm-pw" class="form-control"
                                        placeholder="Confirm new password" />
                                </div>
                                <button class="btn btn-gold" onclick="changePassword()">üíæ Save Password</button>

                                <div style="margin-top:32px;padding-top:24px;border-top:1px solid var(--glass-border)">
                                    <p style="font-size:0.85rem;color:var(--text-muted);margin-bottom:16px">Danger Zone
                                    </p>
                                    <button class="btn btn-red btn-sm" onclick="confirmClearAll()">üóëÔ∏è Clear All
                                        Data</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Edit Player Modal -->
    <div class="modal-overlay" id="edit-player-modal">
        <div class="modal">
            <h2>‚úèÔ∏è Edit Player</h2>
            <input type="hidden" id="edit-mobile" />
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="edit-name" class="form-control" />
            </div>
            <div class="form-group">
                <label>Role</label>
                <select id="edit-role" class="form-control">
                    <option value="Batsman">Batsman</option>
                    <option value="Bowler">Bowler</option>
                    <option value="All-Rounder">All-Rounder</option>
                    <option value="Wicketkeeper">Wicketkeeper</option>
                </select>
            </div>
            <div class="form-group">
                <label>Match Type</label>
                <select id="edit-type" class="form-control">
                    <option value="Leather">Leather</option>
                    <option value="Tennis">Tennis</option>
                    <option value="Box">Box</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('edit-player-modal')">Cancel</button>
                <button class="btn btn-gold" onclick="savePlayerEdit()">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Player Modal -->
    <div class="modal-overlay" id="del-player-modal">
        <div class="modal">
            <h2>üóëÔ∏è Delete Player?</h2>
            <p style="color:var(--text-muted);font-size:0.9rem">This will permanently delete the player and all their
                match history.</p>
            <input type="hidden" id="del-player-mobile" />
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('del-player-modal')">Cancel</button>
                <button class="btn btn-red" onclick="confirmDeletePlayer()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Edit Match Modal -->
    <div class="modal-overlay" id="edit-match-modal">
        <div class="modal" style="max-width:520px">
            <h2>‚úèÔ∏è Edit Match</h2>
            <input type="hidden" id="edit-match-id" />
            <div class="form-row">
                <div class="form-group"><label>Match Date</label><input type="date" id="em-date" class="form-control" />
                </div>
                <div class="form-group"><label>Tournament</label><input type="text" id="em-tournament"
                        class="form-control" /></div>
            </div>
            <div class="form-row cols-3">
                <div class="form-group"><label>Runs</label><input type="number" id="em-runs" class="form-control" />
                </div>
                <div class="form-group"><label>Balls</label><input type="number" id="em-balls" class="form-control" />
                </div>
                <div class="form-group"><label>Wickets</label><input type="number" id="em-wickets"
                        class="form-control" /></div>
            </div>
            <div class="form-row cols-3">
                <div class="form-group"><label>Overs</label><input type="number" id="em-overs" class="form-control"
                        step="0.1" /></div>
                <div class="form-group"><label>Runs Conc.</label><input type="number" id="em-bruns"
                        class="form-control" /></div>
                <div class="form-group"><label>Catches</label><input type="number" id="em-catches"
                        class="form-control" /></div>
            </div>
            <div class="form-check" onclick="toggleEditMOTM()">
                <input type="checkbox" id="em-motm" />
                <label for="em-motm">üèÜ Man of the Match</label>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('edit-match-modal')">Cancel</button>
                <button class="btn btn-gold" onclick="saveMatchEdit()">üíæ Save</button>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Nav (only visible when admin panel is shown) -->
    <nav class="mobile-bottom-nav" id="admin-bottom-nav" style="display:none">
        <a href="#" onclick="showSection('players')"><span class="mbn-icon">üë•</span>Players</a>
        <a href="#" onclick="showSection('matches')"><span class="mbn-icon">üìã</span>Matches</a>
        <a href="#" onclick="showSection('settings')"><span class="mbn-icon">‚öôÔ∏è</span>Settings</a>
        <a href="dashboard.html"><span class="mbn-icon">üè†</span>Dashboard</a>
        <a href="#" onclick="adminLogout()"><span class="mbn-icon">üö™</span>Logout</a>
    </nav>

    <div id="toast-container" class="toast-container"></div>

    <!-- DB Loading Overlay -->
    <div id="db-loading"
        style="display:none;position:fixed;inset:0;background:rgba(10,15,30,0.92);z-index:9999;align-items:center;justify-content:center;flex-direction:column;gap:16px">
        <div style="font-size:2rem;animation:spin 1s linear infinite">‚è≥</div>
        <div style="color:#a55eea;font-weight:700;font-size:1rem">Connecting to Admin Database‚Ä¶</div>
    </div>
    <style>
        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="app.js"></script>
    <script>
        let adminLoggedIn = false;
        let dbReady = false;

        // Pre-load DB so admin panel has data immediately after login
        document.getElementById('db-loading').style.display = 'flex';
        initDB().then(() => {
            dbReady = true;
            document.getElementById('db-loading').style.display = 'none';
        }).catch(() => {
            dbReady = true;
            document.getElementById('db-loading').style.display = 'none';
        });

        function doAdminLogin() {
            if (!dbReady) { showToast('Database loading...', 'info'); return; }
            const pw = document.getElementById('admin-pw-input').value;
            if (checkAdmin(pw)) {
                adminLoggedIn = true;
                document.getElementById('admin-login-wrap').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                document.getElementById('admin-bottom-nav').style.display = '';
                showSection('players');
                // Subscribe to real-time updates while admin panel is open
                fbListen('players', (data) => {
                    _playersCache = data ? Object.values(data) : [];
                    if (document.getElementById('section-players').style.display !== 'none') {
                        loadAdminPlayers();
                        updateAdminStamp();
                    }
                });
                fbListen('matches', (data) => {
                    _matchesCache = data ? Object.values(data) : [];
                });
                // 10-second polling ‚Äî any internet, any network
                setInterval(adminRefreshNow, 10000);
            } else {
                showToast('Wrong password!', 'error');
            }
        }
        // Allow pressing enter
        document.getElementById('admin-pw-input').addEventListener('keypress', e => { if (e.key === 'Enter') doAdminLogin(); });

        function adminLogout() { window.location.href = 'index.html'; }

        function adminRefreshNow() {
            if (!adminLoggedIn) return;
            Promise.all([loadPlayersFromDB(), loadMatchesFromDB()]).then(() => {
                loadAdminPlayers();
                updateAdminStamp();
            }).catch(() => loadAdminPlayers());
        }

        function updateAdminStamp() {
            const el = document.getElementById('refresh-stamp');
            if (el) el.textContent = 'üîÑ Updated ' + new Date().toLocaleTimeString('en-IN');
        }

        function showSection(s) {
            ['players', 'matches', 'settings'].forEach(sec => {
                document.getElementById(`section-${sec}`).style.display = sec === s ? 'block' : 'none';
            });
            if (s === 'players') loadAdminPlayers();
            if (s === 'matches') loadPlayerSelect();
        }

        function loadAdminPlayers() {
            const players = getPlayers();
            const tbody = document.getElementById('admin-players-tbody');
            const countEl = document.getElementById('admin-player-count');
            if (countEl) countEl.textContent = `${players.length} player${players.length !== 1 ? 's' : ''} registered`;
            tbody.innerHTML = players.map(p => {
                const s = calcStats(p.mobile);
                const date = p.createdAt ? new Date(p.createdAt).toLocaleDateString('en-IN') : '-';
                const motmBadge = s.bat.motm > 0
                    ? `<span class="badge badge-gold">üèÜ ${s.bat.motm}</span>`
                    : '<span style="color:var(--text-muted)">-</span>';
                return `<tr>
      <td><div style="display:flex;align-items:center;gap:10px">
        <div class="player-mini-avatar" style="width:34px;height:34px;font-size:0.85rem">${initials(p.name)}</div>
        <div>
          <div class="highlight" style="font-weight:700">${p.name}</div>
          <div style="font-size:0.7rem;color:var(--text-muted)">${date !== '-' ? 'üìÖ Joined ' + date : ''}</div>
        </div>
      </div></td>
      <td>
        <span style="font-family:monospace;font-weight:700;font-size:0.85rem;color:var(--accent-gold);background:rgba(245,166,35,0.12);padding:4px 10px;border-radius:8px;border:1px solid rgba(245,166,35,0.3);letter-spacing:0.5px">üì± ${p.mobile}</span>
      </td>
      <td><span class="badge badge-green">${p.role}</span></td>
      <td><span class="badge badge-blue">${p.matchType}</span></td>
      <td style="font-weight:700;text-align:center">${s.bat.total}</td>
      <td class="gold" style="font-weight:700">${s.bat.runs}</td>
      <td>${s.avg}</td>
      <td>${s.sr}</td>
      <td class="green" style="font-weight:700">${s.bowl.wickets}</td>
      <td>${s.eco}</td>
      <td>${motmBadge}</td>
      <td>
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost btn-sm" onclick="openEditPlayer('${p.mobile}')">‚úèÔ∏è Edit</button>
          <button class="btn btn-red btn-sm" onclick="openDelPlayer('${p.mobile}')">üóëÔ∏è</button>
        </div>
      </td>
    </tr>`;
            }).join('') || '<tr><td colspan="12" style="text-align:center;padding:30px;color:var(--text-muted)">No players registered yet</td></tr>';
        }

        function openEditPlayer(mobile) {
            const p = getPlayerByMobile(mobile);
            document.getElementById('edit-mobile').value = mobile;
            document.getElementById('edit-name').value = p.name;
            document.getElementById('edit-role').value = p.role;
            document.getElementById('edit-type').value = p.matchType;
            document.getElementById('edit-player-modal').classList.add('active');
        }
        function savePlayerEdit() {
            const mobile = document.getElementById('edit-mobile').value;
            const p = getPlayerByMobile(mobile);
            p.name = document.getElementById('edit-name').value.trim() || p.name;
            p.role = document.getElementById('edit-role').value;
            p.matchType = document.getElementById('edit-type').value;
            savePlayer(p);
            closeModal('edit-player-modal');
            loadAdminPlayers();
            showToast('Player updated!');
        }

        function openDelPlayer(mobile) {
            document.getElementById('del-player-mobile').value = mobile;
            document.getElementById('del-player-modal').classList.add('active');
        }
        function confirmDeletePlayer() {
            const mobile = document.getElementById('del-player-mobile').value;
            deletePlayer(mobile);
            closeModal('del-player-modal');
            loadAdminPlayers();
            showToast('Player deleted');
        }

        function loadPlayerSelect() {
            const players = getPlayers();
            const sel = document.getElementById('admin-player-select');
            sel.innerHTML = '<option value="">‚Äî Select Player ‚Äî</option>' +
                players.map(p => `<option value="${p.mobile}">${p.name}</option>`).join('');
        }

        function loadAdminMatches() {
            const mobile = document.getElementById('admin-player-select').value;
            const tbody = document.getElementById('admin-matches-tbody');
            const empty = document.getElementById('admin-matches-empty');
            const table = document.getElementById('admin-matches-table');
            if (!mobile) {
                table.style.display = 'none'; empty.style.display = 'block'; return;
            }
            const matches = getMatchesByPlayer(mobile);
            table.style.display = ''; empty.style.display = 'none';
            tbody.innerHTML = matches.map(m => `<tr>
    <td>${fmtDate(m.matchDate)}</td>
    <td class="highlight">${m.tournament || '-'}</td>
    <td class="gold">${m.runs || 0}</td>
    <td>${m.balls || 0}</td>
    <td class="green">${m.wickets || 0}</td>
    <td>${m.bRuns || 0}</td>
    <td>${m.motm ? 'üèÜ' : '-'}</td>
    <td>
      <div style="display:flex;gap:6px">
        <button class="btn btn-ghost btn-sm" onclick="openEditMatch('${m.id}')">‚úèÔ∏è</button>
        <button class="btn btn-red btn-sm" onclick="doDeleteMatch('${m.id}')">üóëÔ∏è</button>
      </div>
    </td>
  </tr>`).join('') || '<tr><td colspan="8" style="text-align:center;padding:30px;color:var(--text-muted)">No matches</td></tr>';
        }

        function openEditMatch(id) {
            const m = getMatches().find(x => x.id === id);
            if (!m) return;
            document.getElementById('edit-match-id').value = id;
            document.getElementById('em-date').value = m.matchDate;
            document.getElementById('em-tournament').value = m.tournament || '';
            document.getElementById('em-runs').value = m.runs || 0;
            document.getElementById('em-balls').value = m.balls || 0;
            document.getElementById('em-wickets').value = m.wickets || 0;
            document.getElementById('em-overs').value = m.overs || 0;
            document.getElementById('em-bruns').value = m.bRuns || 0;
            document.getElementById('em-catches').value = m.catches || 0;
            document.getElementById('em-motm').checked = !!m.motm;
            document.getElementById('edit-match-modal').classList.add('active');
        }
        function toggleEditMOTM() {
            const cb = document.getElementById('em-motm');
            cb.checked = !cb.checked;
        }
        function saveMatchEdit() {
            const id = document.getElementById('edit-match-id').value;
            const matches = getMatches();
            const idx = matches.findIndex(m => m.id === id);
            if (idx < 0) return;
            matches[idx].matchDate = document.getElementById('em-date').value;
            matches[idx].tournament = document.getElementById('em-tournament').value;
            matches[idx].runs = document.getElementById('em-runs').value;
            matches[idx].balls = document.getElementById('em-balls').value;
            matches[idx].wickets = document.getElementById('em-wickets').value;
            matches[idx].overs = document.getElementById('em-overs').value;
            matches[idx].bRuns = document.getElementById('em-bruns').value;
            matches[idx].catches = document.getElementById('em-catches').value;
            matches[idx].motm = document.getElementById('em-motm').checked;
            saveMatches(matches);
            closeModal('edit-match-modal');
            loadAdminMatches();
            showToast('Match updated!');
        }
        function doDeleteMatch(id) {
            deleteMatch(id);
            loadAdminMatches();
            showToast('Match deleted');
        }

        function changePassword() {
            const np = document.getElementById('new-pw').value.trim();
            const cp = document.getElementById('confirm-pw').value.trim();
            if (!np) { showToast('Enter a new password', 'error'); return; }
            if (np !== cp) { showToast('Passwords do not match', 'error'); return; }
            saveAdminPwToDB(np).then ? saveAdminPwToDB(np).then(() => {
                _adminPwCache = np;
                document.getElementById('new-pw').value = '';
                document.getElementById('confirm-pw').value = '';
                showToast('Password updated!');
            }) : (() => {
                localStorage.setItem('crick_admin_pw', np);
                _adminPwCache = np;
                document.getElementById('new-pw').value = '';
                document.getElementById('confirm-pw').value = '';
                showToast('Password updated!');
            })();
        }

        function confirmClearAll() {
            if (confirm('‚ö†Ô∏è This will delete ALL players and matches. Are you absolutely sure?')) {
                // Clear Firebase
                if (firebaseEnabled && db) {
                    db.ref('players').remove();
                    db.ref('matches').remove();
                } else {
                    localStorage.removeItem('crick_players');
                    localStorage.removeItem('crick_matches');
                }
                _playersCache = [];
                _matchesCache = [];
                showToast('All data cleared');
                loadAdminPlayers();
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        // Close on outside click
        document.querySelectorAll('.modal-overlay').forEach(o => {
            o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); });
        });
    </script>
</body>

</html>